<!DOCTYPE html>
<html>

<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        .sliderCss {
            height: 200px;
        }

        #red .noUi-connect {
            background: #c0392b;
        }

        .lux_display {
            width: 320px;
            padding: 10px;
            border: 5px solid gray;
            margin: 0;
            font-size: 50px;
            text-align: center;
        }
    </style>
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='epoch.min.css') }}">
    <link href="//cdn.bootcss.com/noUiSlider/8.5.1/nouislider.min.css" rel="stylesheet">
</head>

<body>

    <h1>Light Brighness:</h1>
    <div id="slider" class="sliderCss noUi-connect"></div>

    <br></br>

    <input id="input-format">

    <div class="luxvalue">
        <h1>Lux Value:</h1>
        <div id='lux' class="lux_display"></div>
    </div>

    <br>
    <br></br>
    </br>
    <div id="lineChart" class="epoch" style="width: 1200px; height: 400px"></div>


    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script src="https://d3js.org/d3.v3.min.js"></script>
    <script src="//cdn.bootcss.com/noUiSlider/8.5.1/nouislider.js"></script>
    <script type="text/javascript" src="{{ url_for('static', filename='epoch.min.js') }}"></script>
    <script>

        http_url = 'http://140.193.207.68:5000/signal/'

        var xhr = new XMLHttpRequest();
        var data = new FormData();

        var sliderFormat = document.getElementById('slider');
        noUiSlider.create(sliderFormat, {
            start: 20,
            step: 10,
            orientation: 'vertical',
            range: {
                'min': 0,
                'max': 100
            },
            format: {
                to: function (value) {
                    return value;
                },
                from: function (value) {
                    return value;
                }
            }
        });

        var inputFormat = document.getElementById('input-format');
        inputFormat.addEventListener('change', function () {
            sliderFormat.noUiSlider.set(this.value);
        });

        sliderFormat.noUiSlider.on('update', function (values, handle) {
            inputFormat.value = values[handle];
        });

        sliderFormat.noUiSlider.on('set', function (values, handle) {
            // console.log(values[handle]);
            xhr.open('POST', http_url, true);
            data.append('led_value', values[handle]);
            xhr.send(data);
            data.delete('led_value')
        });


        $(function poll() {
            var $flux_value = $('#lux');
            setTimeout(function () {
                $.ajax({
                    type: 'GET', url: 'http://140.193.207.68:5000/flux/', success: function (flux_value) {
                        //Update flux value
                        $flux_value.text(flux_value['lux_value']);
                        //  $flux_value.text(i);Â 
                        // i = i+1;
                        // console.log(i);
                        //Setup the next poll recursively
                        poll();
                    }, dataType: "json"
                });
            }, 1000);
        });

        var lineChartData = [
            { label: 'Series 1', values: [], range: 'range-l' }
        ];

        var myChart = $('#lineChart').epoch({
            type: 'time.line',
            data: lineChartData,
            range: {
                left: 'range-l',
                right: [0, 100]
            },
            axes: ['bottom', 'left'],
            // ticks: { time: 30 },
            // windowSize: 180,
            ticks: { time: 5 },
            windowSize: 30,
        });

        $(function pollChart() {
            setTimeout(function () {
                $.ajax({
                    type: 'GET', url: 'http://140.193.207.68:5000/chart/', success: function (data) {
                        //Update flux value                        
                        var newBarChartData = [{ time: data['seconds'][0], y: data['seconds'][1] }];
                        myChart.push(newBarChartData);
                        pollChart();
                    }, dataType: "json"
                });
            }, 1000);
        });

    </script>
</body>

</html>